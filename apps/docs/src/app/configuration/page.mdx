# Configuration Guide

This guide covers all configuration options for the NovAI system, including environment variables, database setup, AI provider configuration, and deployment settings.

## Environment Variables

### Required Variables

```bash
# Database Configuration
DATABASE_URL=postgresql://username:password@localhost:5432/novai

# JWT Secret
JWT_SECRET=your-super-secret-jwt-key

# AI Provider Configuration
OPENAI_API_KEY=sk-your-openai-api-key
ANTHROPIC_API_KEY=sk-ant-your-anthropic-api-key

# Optional: Alternative AI Providers
GOOGLE_AI_API_KEY=your-google-ai-key
COHERE_API_KEY=your-cohere-api-key
```

### Optional Variables

```bash
# Server Configuration
PORT=3001
NODE_ENV=development

# Redis (for caching and sessions)
REDIS_URL=redis://localhost:6379

# File Storage
AWS_ACCESS_KEY_ID=your-aws-access-key
AWS_SECRET_ACCESS_KEY=your-aws-secret-key
AWS_REGION=us-east-1
AWS_S3_BUCKET=novai-uploads

# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password

# Monitoring
SENTRY_DSN=your-sentry-dsn
DATADOG_API_KEY=your-datadog-key
```

## Database Setup

### PostgreSQL Configuration

1. **Install PostgreSQL**:
   ```bash
   # Ubuntu/Debian
   sudo apt-get install postgresql postgresql-contrib
   
   # macOS
   brew install postgresql
   
   # Windows
   # Download from https://www.postgresql.org/download/windows/
   ```

2. **Create Database**:
   ```sql
   CREATE DATABASE novai;
   CREATE USER novai_user WITH PASSWORD 'your_password';
   GRANT ALL PRIVILEGES ON DATABASE novai TO novai_user;
   ```

3. **Run Migrations**:
   ```bash
   cd apps/api
   pnpm migration:run
   ```

### Database Schema

The database includes the following main tables:

```sql
-- Users and Authentication
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Tenants (Multi-tenancy)
CREATE TABLE tenants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  domain VARCHAR(255) UNIQUE,
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW()
);

-- Campaigns
CREATE TABLE campaigns (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id),
  name VARCHAR(255) NOT NULL,
  description TEXT,
  ruleset VARCHAR(100) NOT NULL,
  data_sources JSONB DEFAULT '[]',
  ai_agent_config JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW()
);

-- Games
CREATE TABLE games (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID REFERENCES campaigns(id),
  user_id UUID REFERENCES users(id),
  state JSONB NOT NULL,
  history JSONB DEFAULT '[]',
  status VARCHAR(50) DEFAULT 'active',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Data Sources
CREATE TABLE data_sources (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id),
  name VARCHAR(255) NOT NULL,
  type VARCHAR(50) NOT NULL,
  content TEXT,
  metadata JSONB DEFAULT '{}',
  status VARCHAR(50) DEFAULT 'processing',
  created_at TIMESTAMP DEFAULT NOW()
);
```

## AI Provider Configuration

### OpenAI Configuration

```typescript
// apps/api/src/config/ai-providers.ts
export const openAIConfig = {
  apiKey: process.env.OPENAI_API_KEY,
  model: 'gpt-4-turbo',
  temperature: 0.7,
  maxTokens: 2000,
  timeout: 30000,
  retries: 3,
  fallback: {
    model: 'gpt-3.5-turbo',
    temperature: 0.8
  }
};
```

### Anthropic Configuration

```typescript
export const anthropicConfig = {
  apiKey: process.env.ANTHROPIC_API_KEY,
  model: 'claude-3-sonnet-20240229',
  maxTokens: 4000,
  temperature: 0.7,
  timeout: 60000,
  retries: 3
};
```

### Provider Selection

```typescript
// apps/api/src/services/ai-service.ts
export class AIService {
  private providers: Map<string, AIProvider> = new Map();
  
  constructor() {
    this.providers.set('openai', new OpenAIProvider(openAIConfig));
    this.providers.set('anthropic', new AnthropicProvider(anthropicConfig));
  }
  
  async getResponse(prompt: string, provider: string = 'openai') {
    const aiProvider = this.providers.get(provider);
    if (!aiProvider) {
      throw new Error(`Provider ${provider} not found`);
    }
    
    return await aiProvider.generate(prompt);
  }
}
```

## Campaign Configuration

### Campaign JSON Structure

```json
{
  "id": "baldurs-gate-3",
  "name": "Baldur's Gate 3",
  "description": "An epic adventure in the Forgotten Realms",
  "ruleset": "dnd-5e",
  "dataSources": [
    "campaigns/baldurs-gate-3/intro.md",
    "campaigns/baldurs-gate-3/characters.md",
    "campaigns/baldurs-gate-3/rules.md",
    "campaigns/baldurs-gate-3/lore.md"
  ],
  "aiAgent": {
    "provider": "openai",
    "model": "gpt-4-turbo",
    "temperature": 0.7,
    "personality": {
      "type": "narrative-focused",
      "style": "immersive and descriptive",
      "knowledge": "deep understanding of D&D 5e"
    },
    "memory": {
      "type": "conversation",
      "maxLength": 10,
      "importance": "high"
    },
    "context": {
      "includeRules": true,
      "includeLore": true,
      "includeHistory": true,
      "maxContextLength": 4000
    }
  },
  "world": {
    "name": "Forgotten Realms",
    "description": "A rich fantasy world with deep lore",
    "locations": [
      {
        "id": "baldurs-gate",
        "name": "Baldur's Gate",
        "description": "A bustling city on the Sword Coast"
      }
    ],
    "npcs": [
      {
        "id": "astarion",
        "name": "Astarion",
        "race": "High Elf",
        "class": "Rogue",
        "personality": "Charming but manipulative"
      }
    ]
  },
  "rules": {
    "combat": {
      "initiative": true,
      "turnBased": true,
      "damageCalculation": "dnd-5e"
    },
    "skills": {
      "system": "dnd-5e",
      "proficiencyBonus": true
    },
    "magic": {
      "spellSlots": true,
      "components": true,
      "concentration": true
    }
  }
}
```

## Web Application Configuration

### Next.js Configuration

```typescript
// apps/web/next.config.ts
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  transpilePackages: ['@workspace/ui', '@workspace/engine'],
  experimental: {
    serverComponentsExternalPackages: ['@workspace/engine']
  },
  env: {
    NEXT_PUBLIC_API_URL: process.env.NEXT_PUBLIC_API_URL,
    NEXT_PUBLIC_APP_URL: process.env.NEXT_PUBLIC_APP_URL
  },
  images: {
    domains: ['localhost', 'api.novai.com']
  }
};

export default nextConfig;
```

### Authentication Configuration

```typescript
// apps/web/app/api/auth/[...nextauth]/authOptions.ts
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';
import GitHubProvider from 'next-auth/providers/github';
import CredentialsProvider from 'next-auth/providers/credentials';

export const authOptions = {
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
    GitHubProvider({
      clientId: process.env.GITHUB_CLIENT_ID!,
      clientSecret: process.env.GITHUB_CLIENT_SECRET!,
    }),
    CredentialsProvider({
      name: 'Credentials',
      credentials: {
        email: { label: "Email", type: "email" },
        password: { label: "Password", type: "password" }
      },
      async authorize(credentials) {
        // Custom authentication logic
        return null;
      }
    })
  ],
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.accessToken = user.accessToken;
      }
      return token;
    },
    async session({ session, token }) {
      session.accessToken = token.accessToken;
      return session;
    }
  }
};
```

## Development Configuration

### Local Development Setup

1. **Clone and Install**:
   ```bash
   git clone <repository-url>
   cd novai
   pnpm install
   ```

2. **Environment Setup**:
   ```bash
   cp .env.example .env
   # Edit .env with your configuration
   ```

3. **Database Setup**:
   ```bash
   # Start PostgreSQL
   brew services start postgresql
   
   # Create database
   createdb novai
   
   # Run migrations
   cd apps/api
   pnpm migration:run
   ```

4. **Start Development Servers**:
   ```bash
   pnpm dev
   ```

### Development Scripts

```json
{
  "scripts": {
    "dev": "turbo dev",
    "build": "turbo build",
    "check": "turbo check",
    "format": "turbo format",
    "test": "turbo test",
    "db:migrate": "cd apps/api && pnpm migration:run",
    "db:seed": "cd apps/api && pnpm seed",
    "db:reset": "cd apps/api && pnpm migration:reset"
  }
}
```

## Production Deployment

### Docker Configuration

```dockerfile
# Dockerfile
FROM node:20-alpine AS base

# Install dependencies
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package.json pnpm-lock.yaml ./
RUN npm install -g pnpm
RUN pnpm install --frozen-lockfile

# Build application
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN pnpm build

# Production image
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/apps/web/public ./apps/web/public
COPY --from=builder /app/apps/web/.next/standalone ./
COPY --from=builder /app/apps/web/.next/static ./apps/web/.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "apps/web/server.js"]
```

### Docker Compose

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: novai
      POSTGRES_USER: novai_user
      POSTGRES_PASSWORD: novai_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    environment:
      DATABASE_URL: postgresql://novai_user:novai_password@postgres:5432/novai
      REDIS_URL: redis://redis:6379
      JWT_SECRET: your-jwt-secret
      OPENAI_API_KEY: your-openai-key
    ports:
      - "3001:3001"
    depends_on:
      - postgres
      - redis

  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    environment:
      NEXT_PUBLIC_API_URL: http://api:3001
    ports:
      - "3000:3000"
    depends_on:
      - api

  docs:
    build:
      context: .
      dockerfile: Dockerfile.docs
    ports:
      - "3002:3000"
    depends_on:
      - api

volumes:
  postgres_data:
```

### Environment Variables for Production

```bash
# Production Environment Variables
NODE_ENV=production
PORT=3001

# Database
DATABASE_URL=postgresql://novai_user:novai_password@postgres:5432/novai
REDIS_URL=redis://redis:6379

# Security
JWT_SECRET=your-super-secret-jwt-key-production
COOKIE_SECRET=your-cookie-secret

# AI Providers
OPENAI_API_KEY=sk-your-openai-api-key
ANTHROPIC_API_KEY=sk-ant-your-anthropic-api-key

# File Storage
AWS_ACCESS_KEY_ID=your-aws-access-key
AWS_SECRET_ACCESS_KEY=your-aws-secret-key
AWS_REGION=us-east-1
AWS_S3_BUCKET=novai-uploads

# Monitoring
SENTRY_DSN=your-sentry-dsn
DATADOG_API_KEY=your-datadog-key

# Email
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

## Monitoring and Logging

### Application Monitoring

```typescript
// apps/api/src/monitoring/sentry.ts
import * as Sentry from '@sentry/node';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0,
});

// apps/api/src/monitoring/datadog.ts
import { tracer } from 'dd-trace';

tracer.init({
  service: 'novai-api',
  env: process.env.NODE_ENV,
});
```

### Logging Configuration

```typescript
// apps/api/src/config/logger.ts
import winston from 'winston';

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: { service: 'novai-api' },
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ],
});

if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple()
  }));
}
```

## Security Configuration

### CORS Configuration

```typescript
// apps/api/src/config/cors.ts
export const corsOptions = {
  origin: [
    'http://localhost:3000',
    'http://localhost:3002',
    'https://novai.com',
    'https://docs.novai.com'
  ],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  allowedHeaders: ['Content-Type', 'Authorization']
};
```

### Rate Limiting

```typescript
// apps/api/src/middleware/rate-limit.ts
import rateLimit from 'express-rate-limit';

export const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 10, // limit each IP to 10 requests per windowMs
  message: 'Too many authentication attempts'
});

export const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // limit each IP to 100 requests per windowMs
  message: 'Too many API requests'
});
```

## Performance Optimization

### Caching Configuration

```typescript
// apps/api/src/config/cache.ts
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL);

export const cacheConfig = {
  ttl: 300, // 5 minutes
  prefix: 'novai:',
  redis
};

export async function cacheGet(key: string) {
  return await redis.get(`novai:${key}`);
}

export async function cacheSet(key: string, value: string, ttl: number = 300) {
  return await redis.setex(`novai:${key}`, ttl, value);
}
```

### Database Optimization

```sql
-- Create indexes for better performance
CREATE INDEX idx_games_user_id ON games(user_id);
CREATE INDEX idx_games_campaign_id ON games(campaign_id);
CREATE INDEX idx_games_status ON games(status);
CREATE INDEX idx_data_sources_tenant_id ON data_sources(tenant_id);
CREATE INDEX idx_data_sources_status ON data_sources(status);

-- Partition large tables
CREATE TABLE games_partitioned (
  LIKE games INCLUDING ALL
) PARTITION BY RANGE (created_at);

CREATE TABLE games_2024_01 PARTITION OF games_partitioned
  FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

## Troubleshooting

### Common Issues

1. **Database Connection Issues**:
   ```bash
   # Check PostgreSQL status
   brew services list | grep postgresql
   
   # Restart PostgreSQL
   brew services restart postgresql
   ```

2. **AI Provider Issues**:
   ```bash
   # Test OpenAI API
   curl -H "Authorization: Bearer $OPENAI_API_KEY" \
        https://api.openai.com/v1/models
   ```

3. **Memory Issues**:
   ```bash
   # Monitor memory usage
   htop
   
   # Check for memory leaks
   node --inspect apps/api/src/main.ts
   ```

### Debug Mode

```bash
# Enable debug logging
DEBUG=novai:* pnpm dev

# Enable verbose logging
LOG_LEVEL=debug pnpm dev
```

## Next Steps

- **[Environment Variables](/configuration/env)** - Detailed environment variable reference
- **[Database Setup](/configuration/database)** - Advanced database configuration
- **[AI Provider Setup](/configuration/ai-providers)** - Configure different AI providers
- **[Deployment](/configuration/deployment)** - Production deployment guide 